name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For README badge updates

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Fallback for any remaining git deps

      - name: Install Foundry (latest stable)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      # -------------------------------------------------
      # Soldeer: Clean install + explicit Git for c3caller
      # -------------------------------------------------
      - name: Install Soldeer dependencies
        run: |
          # Fresh clean install
          forge soldeer install --clean
          # Standard update for non-Git deps
          forge soldeer update
          # Explicit Git for c3caller (fixes "cannot install")
          forge soldeer install c3caller --git https://github.com/ContinuumDAO/c3caller.git --branch main --recursive-deps
        # If pinning: add --rev <commit-hash> above

      - name: Install Node.js & coverage tools
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          sudo apt-get update && sudo apt-get install -y lcov bc
          npm install -g lcov-badge-generator

      # -------------------------------------------------
      # Your build pipeline
      # -------------------------------------------------
      - name: Run full build pipeline (helpers/all.sh)
        run: |
          chmod +x helpers/*.sh
          ./helpers/all.sh
        env:
          FOUNDRY_PROFILE: default

      # -------------------------------------------------
      # Tests & Coverage (unchanged)
      # -------------------------------------------------
      - name: Run tests
        run: forge test -vvv

      - name: Generate coverage
        run: |
          forge coverage --report lcov --report-file lcov.info --via-ir
          sed -i '/lib\/openzeppelin/d' lcov.info || true
          sed -i '/lib\/forge-std/d' lcov.info || true
          sed -i '/dependencies\/c3caller/d' lcov.info || true  # Exclude c3caller noise

      - name: Compute coverage badge
        id: coverage
        run: |
          coverage=$(lcov-badge-generator lcov.info | grep -o '[0-9]\+\.[0-9]\+%' || echo "0%")
          percent=$(echo $coverage | tr -d '%')

          if   (( $(echo "$percent >= 95" | bc -l) )); then color="brightgreen"
          elif (( $(echo "$percent >= 90" | bc -l) )); then color="green"
          elif (( $(echo "$percent >= 80" | bc -l) )); then color="yellowgreen"
          elif (( $(echo "$percent >= 70" | bc -l) )); then color="yellow"
          else color="red"
          fi

          badge="https://img.shields.io/badge/coverage-$coverage-$color?style=flat-square"
          echo "badge_url=$badge" >> $GITHUB_OUTPUT

      - name: Update coverage badge in README
        if: github.ref == 'refs/heads/main'
        run: |
          sed -i "s|https://img.shields.io/badge/coverage-[^ ]*-[^ ]*|${{ steps.coverage.outputs.badge_url }}|g" README.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update coverage badge [skip ci]" || exit 0
          git push

      - name: Upload artifacts (for debugging)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-artifacts
          path: |
            lcov.info
            dependencies/  # Inspect c3caller install
            cache/
